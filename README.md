# Filmorate — сервис рекомендаций фильмов (финальное задание 10-12 спринтов)


## Описание проекта

**Filmorate** — полнофункциональное Spring Boot‑приложение для управления фильмами и профилями пользователей с долговременным хранением данных. Ключевые возможности:
- регистрация и управление пользователями;
- работа с фильмами (включая жанры и рейтинги);
- система дружбы (односторонняя);
- лайки фильмов и рейтинг популярности;
- рекомендации на основе лайков;
- сохранение состояния между перезапусками через базу данных.

## Текущая функциональность

### Основные сущности
- **Пользователи** (`User`): профиль, дружба, лайки.
- **Фильмы** (`Film`): метаданные, жанры, рейтинги, лайки.
- **Жанры** (`Genre`): классификация фильмов.
- **Рейтинги** (`Rating`): возрастные ограничения (MPAA или российская система).

### Ключевые API‑эндпоинты

**Пользователи и дружба:**
- `GET /users/{id}` — получить пользователя по ID.
- `PUT /users/{id}/friends/{friendId}` — добавить в друзья (односторонне).
- `DELETE /users/{id}/friends/{friendId}` — удалить из друзей.
- `GET /users/{id}/friends` — список друзей пользователя.
- `GET /users/{id}/friends/common/{otherId}` — общие друзья.

**Фильмы и рейтинги:**
- `GET /films/{id}` — получить фильм по ID.
- `PUT /films/{id}/like/{userId}` — поставить лайк.
- `DELETE /films/{id}/like/{userId}` — убрать лайк.
- `GET /films/popular?count={count}` — топ фильмов по лайкам.
- `GET /genres` — список всех жанров.
- `GET /genres/{id}` — жанр по ID.
- `GET /mpa` — список всех рейтингов (5 элементов).
- `GET /mpa/{id}` — рейтинг по ID.

## Архитектура приложения

### Слои приложения
1. **Контроллеры** (`controller` package)
    - Обрабатывают HTTP‑запросы.
    - Внедряют сервисы через `@Autowired`.
    - Возвращают корректные HTTP‑коды.

2. **Сервисы** (`service` package)
    - `UserService`: управление дружбой, общими друзьями.
    - `FilmService`: лайки, рейтинг, работа с жанрами и рейтингами.
    - Аннотированы `@Service`.

3. **Хранилища (DAO)** (`storage` package)
    - Интерфейсы: `UserStorage`, `FilmStorage`.
    - Реализации:
        - `InMemoryUserStorage`, `InMemoryFilmStorage` (для совместимости).
        - `UserDbStorage`, `FilmDbStorage` (работа с H2).
    - Используют `@Qualifier` для различения бинов.
    - Работают через `JdbcTemplate`.

### Хранение данных
- **База данных**: H2 (встроенная).
    - Режим тестирования: память (`mem`).
    - Рабочий режим: файл (`./db/filmorate`).
- **Скрипты БД**:
    - `schema.sql` — создание таблиц и индексов.
    - `data.sql` — инициализация данных (опционально).
- **Конфигурация**: `application.properties`.

## Валидация и ошибки

- **Валидация данных**: Jakarta Validation (`@NotNull`, `@Email` и др.).
- **Обработка ошибок**:
    - `400 Bad Request` — ошибка валидации (`ValidationException`).
    - `404 Not Found` — объект не найден.
    - `500 Internal Server Error` — непредвиденное исключение.
- **Централизованный обработчик**: `@ExceptionHandler`.

## Логирование

- **Базовый логгер**: `slf4j` + `@Slf4j` (Lombok).
- **HTTP‑логи**: Logbook (`logging.level.org.zalando.logbook: TRACE`).

## Тестирование

### Интеграционные тесты
- Аннотация `@JdbcTest` — создаёт контекст для работы с БД.
- `@AutoConfigureTestDatabase` — использует тестовую БД вместо основной.
- `@RequiredArgsConstructor(onConstructor_ = @Autowired)` — внедрение зависимостей в тестовый класс.
- Покрытие: все публичные методы DAO.

## Технические детали

- **Фреймворк**: Spring Boot.
- **Язык**: Java.
- **БД**: H2 (встроенная).
- **ORM**: JdbcTemplate (без Hibernate).
- **Библиотеки**:
    - Lombok (`@Data`, `@Slf4j`).
    - Jakarta Validation.
    - Logbook.
- **Структура пакетов**:
    - `controller` — REST‑эндпоинты.
    - `service` — бизнес‑логика.
    - `storage` — DAO и хранилища.
    - `model` — DTO и сущности.
    - `repository` — SQL‑скрипты (`schema.sql`, `data.sql`).

## Схема базы данных

Актуальная структура данных представлена на диаграмме:  
![Диаграмма базы данных](diagram_db.png)